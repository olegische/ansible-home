# Конфигурация домашней станции
Использую Debian. На системе установлены только системные утилиты.

## Последовательность запуска плейбуков
Запускаем bash script для установки Ansible.
```
# ./scripts/install_ansible.sh
```
Конфигурируем Ansible:
```
# ansible-playbook configure-ansible.yml
```
Действия плейбука configure-ansible.yml:
- Установка пакетов openssh-client и openssl (для генерации рандомных паролей).
- Добавление в систему пользователя ansible.
+ Настройки для пользоваетля ansible
  + Генерация SSH ключей (тип rsa, 4096 бит) с passphrase.
  + Настройка SSH клиента для мультиплексирования SSH сессий.
  + Сохранение рандомного пароля в файл /etc/ansible/.ansible_become_pass.yml.
  + Шифрование файла с паролем программой ansible-vault.
  + Сохранение пароля в файл /etc/ansible/.passwd/ansible.(hostname).

Дальнейшая работа с ansible-playbook производится с параметром --ask-vault-pass

После выполнения настройки Ansible можно произвести конфигурацию домашней станции:
```
# ansible-playbook home.yml --ask-vault-pass
```

Для пользователей, указанных в переменной users, будут заданы рандомные пароли, 
если пользователь не зарегистрирован в системе.

Плейбук задает станции роли:
- work
- nvidia

## Действия ролей
Роль **nvidia** зависит от роли **media**, которая в свою очередь зависит от роли **common**.

Действия роли **common**:
- Обновление репозитория apt и установка пакетов sudo, openssl (для генерации рандомных паролей).
- Добавляет пользователей в систему (указанных в переменной users).
- Настраивает файл sudoers для пользователей (см ansible-home/roles/common/{files,templates}/

Роли **media** устанавливает в систему следующие пакеты:
- xfce4
- xfce4-goodies
- greybird-gtk-theme
- numix-icon-theme
- breeze-cursor-theme
- vlc

Роль **nvidia** устанавливает драйвера Nvidia из репозиториев contrib и non-free. 
Для Debian Buster это производится путем установки nvidia-driver.
После установки драйвера система перезагружается.

Роль **work** устанавливает в систему пакеты, необходимые для работы. На данный момент это:
- vim
- rsync
- git
- remmina
- cups

## Безопасность
Конфигурация позволяет работать от пользователя ansible.
С помощью плейбука configure-ansible.yml можно периодически рандомить пароль ansible 
и изменять vault password для файла с паролем. Для домашней станции это избыточно, 
но подход позволяет привычно работать при конфигурации виртуальных машин 
сервером Ansible.

Аутентификация производится в два этапа. Во-первых, необходимо указать пароль 
для зашифрованного файла с паролем пользователя ansible на сервере Ansible.
Во-вторых, необходимо указать passphrase для ключа при SSH соединении с 
клиентом сервера Ansible. Работа на клиенте производится от пользователя ansible. 
Файлы с паролями пользователей ansible на удаленных машинах хранятся в папке 
/etc/ansible/.passwd/ansible.hostname, где вместо hostname используется имя машины 
клиента, указанное в файле hosts.